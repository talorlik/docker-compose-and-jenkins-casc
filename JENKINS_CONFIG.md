# Jenkins Configuration as Code (JCasC) Documentation

> [!NOTE]
>
> This document provides a detailed explanation of the `jenkins.yaml`
> configuration file used to configure Jenkins via Configuration as Code (JCasC).

## Table of Contents

- [Overview](#overview)
- [Top-Level Configuration](#top-level-configuration)
- [Security Configuration](#security-configuration)
- [Authorization Strategy](#authorization-strategy)
- [System Settings](#system-settings)
- [Node Configuration](#node-configuration)
- [Docker Cloud Configuration](#docker-cloud-configuration)
- [Unclassified Settings](#unclassified-settings)
- [Tool Installations](#tool-installations)

## Overview

The `jenkins.yaml` file uses YAML syntax to define Jenkins configuration declaratively.
This allows you to version control your Jenkins setup and reproduce it consistently
across environments.

## Top-Level Configuration

### `jenkins.systemMessage`

```yaml
systemMessage: "Jenkins configured automatically by Jenkins Configuration as Code"
```

**What it does**: Sets a system message that appears at the top of the Jenkins dashboard.

**Purpose**: Provides information to users about how Jenkins is configured.
This message is visible to all users when they access the Jenkins web interface.

**Customization**: Change the message to reflect your organization's policies
or setup information.

## Security Configuration

### `jenkins.securityRealm.local`

```yaml
securityRealm:
  local:
    allowsSignup: false
    enableCaptcha: false
    users:
      - id: "admin"
        name: "Jenkins Admin"
        password: "${JENKINS_ADMIN_PASSWORD}"
      - id: "devops"
        name: "DevOps User"
        password: "${JENKINS_DEVOPS_PASSWORD}"
```

**What it does**: Configures local user authentication for Jenkins.

**Key Components**:

- **`allowsSignup: false`**: Prevents users from creating their own accounts.
Only users defined in this configuration can log in.
- **`enableCaptcha: false`**: Disables CAPTCHA on the login page.
- **`users`**: Array of user accounts with the following properties:
  - **`id`**: The username used for login.
  - **`name`**: Display name shown in the UI.
  - **`password`**: User password (supports environment variable substitution).
    - `${JENKINS_ADMIN_PASSWORD}`: Admin user password loaded from
    Docker Compose secrets.
    - `${JENKINS_DEVOPS_PASSWORD}`: DevOps user password loaded from
    Docker Compose secrets.

**Security Note**: Passwords are managed through Docker Compose secrets and loaded
into environment variables at container startup. Never commit plain-text passwords
to version control. The secrets are stored in the `secrets/` directory (git-ignored)
and are automatically generated by the `setup-jenkins.sh` script.

## Authorization Strategy

### `jenkins.authorizationStrategy.globalMatrix`

```yaml
authorizationStrategy:
  globalMatrix:
    entries:
      - user:
          name: "admin"
          permissions:
            - "Overall/Administer"

      - user:
          name: "devops"
          permissions:
            - "Overall/Read"
            - "Job/Read"
            - "Job/Discover"
            - "Job/Build"
            - "Job/Cancel"
            - "Job/Configure"
            - "Job/Create"
            - "Job/Delete"
            - "Job/Move"
            - "Job/Workspace"
            - "Run/Replay"
            - "Run/Update"
            - "Run/Delete"
            - "View/Read"
            - "View/Configure"
            - "View/Create"
            - "View/Delete"
            - "Credentials/Create"
            - "Credentials/Delete"
            - "Credentials/ManageDomains"
            - "Credentials/Update"
            - "Credentials/View"
            - "Agent/Connect"
            - "Agent/Disconnect"
            - "Agent/Configure"
            - "Agent/Provision"
            - "SCM/Tag"

      - group:
          name: "authenticated"
          permissions:
            - "Overall/Read"
            - "Job/Read"
            - "Job/Discover"
            - "Job/Build"
            - "Job/Cancel"
            - "View/Read"
```

**What it does**: Defines fine-grained permissions for users and groups using a
matrix-based authorization strategy.

**Structure**: The `entries` array contains permission entries, each specifying either
a `user` or `group` with their associated `permissions` list.

**Entry Types**:

- **`user`**: Individual user entry with:
  - **`name`**: The username (must match a user defined in
    `securityRealm.local.users`)
  - **`permissions`**: Array of permission strings
    (e.g., `"Overall/Administer"`, `"Job/Build"`)

- **`group`**: Group entry with:
  - **`name`**: The group name (e.g., `"authenticated"` for all logged-in users)
  - **`permissions`**: Array of permission strings

**Permission Format**: Permission strings use the format `"Category/Permission"`
(e.g., `"Overall/Administer"`, `"Job/Build"`).

**Permission Categories Explained**:

- **`Overall/*`**: System-wide permissions (Administer, Read, Create, Delete).
- **`Job/*`**: Job-related permissions (Build, Cancel, Configure, Create, Delete,
Discover, Move, Read, Workspace).
- **`Agent/*`**: Agent management permissions (Configure, Connect, Create, Delete,
Disconnect, Provision).
- **`Run/*`**: Build run permissions (Delete, Replay, Update).
- **`View/*`**: View permissions (Configure, Create, Delete, Read).
- **`Credentials/*`**: Credential management permissions
(ManageDomains, Update, View, Create, Delete).
- **`SCM/*`**: Source control permissions (Tag).
- **`Metrics/*`**: Metrics and monitoring permissions (HealthCheck, ThreadDump, View).

**In This Configuration**:

- **Admin user** (`admin`): Has `Overall/Administer` - full administrative
access to Jenkins.
- **DevOps user** (`devops`): Has extensive permissions for managing jobs, agents,
credentials, views, and SCM operations, but **not** `Overall/Administer`.
This allows the devops user to perform most operational tasks without full system
administration rights.
- **Authenticated users group** (`authenticated`): Has limited permissions
  - can read, build, cancel jobs, access workspaces, and read views.
  This provides basic functionality for all logged-in users.

**Alternative Strategies**: You could also use:

- `loggedInUsersCanDoAnything`: All logged-in users have admin access
(not recommended for production).
- `roleStrategy`: Role-based access control (more complex but more flexible).

## System Settings

### `jenkins.crumbIssuer`

```yaml
crumbIssuer:
  standard:
    excludeClientIPFromCrumb: false
```

**What it does**: Configures CSRF (Cross-Site Request Forgery) protection.

**Components**:

- **`standard`**: Uses Jenkins' standard crumb issuer.
- **`excludeClientIPFromCrumb: false`**: Includes the client IP address in the
CSRF token.

**Purpose**: Prevents CSRF attacks by requiring a token (crumb) for
state-changing operations.

**Note**: Setting `excludeClientIPFromCrumb: true` can help with load balancers
or proxies, but may reduce security.

### `jenkins.disableRememberMe`

```yaml
disableRememberMe: false
```

**What it does**: Controls whether users can use the "Remember Me" checkbox on
the login page.

- **`false`**: Users can check "Remember Me" to stay logged in.
- **`true`**: "Remember Me" option is disabled.

### `jenkins.numExecutors`

```yaml
numExecutors: 0
```

**What it does**: Sets the number of concurrent builds that can run on the
Jenkins master node.

**Purpose**: Controls resource usage. More executors = more parallel builds,
but also more CPU/memory usage.

**Best Practice**: When using Docker Cloud agents (as in this setup),
set `numExecutors` to `0` to ensure all builds run on Docker agents rather than
on the master node. This:

- Keeps the master node dedicated to managing Jenkins and coordinating builds
- Ensures all builds run in isolated Docker containers
- Prevents resource contention on the master node
- Provides better isolation and reproducibility for builds

**Alternative**: If you need some builds to run on the master node, set this to
a positive number (typically the number of CPU cores, or slightly less).

### `jenkins.mode`

```yaml
mode: NORMAL
```

**What it does**: Sets the Jenkins instance mode.

**Options**:

- **`NORMAL`**: Standard mode - Jenkins can run builds and manage agents.
- **`EXCLUSIVE`**: Jenkins only runs builds, no agent management.
- **`NORMAL`** is the standard choice for most setups.

## Node Configuration

### `jenkins.nodes`

```yaml
nodes:
  - permanent:
      name: "master"
      numExecutors: 2
      description: "Built-in Jenkins node"
      remoteFS: "/var/jenkins_home"
      labelString: "master"
      launcher:
        jnlp:
          workDirSettings:
            disabled: false
            failIfWorkDirIsMissing: false
            internalDir: "remoting"
            workDirPath: "/var/jenkins_home"
```

**What it does**: Configures the Jenkins master node (the built-in node).

**Components**:

- **`permanent`**: Defines a permanent node (as opposed to temporary/ephemeral).
- **`name: "master"`**: Node identifier.
- **`numExecutors: 2`**: Number of concurrent builds on this node.
- **`description`**: Human-readable description.
- **`remoteFS: "/var/jenkins_home"`**: Root filesystem path for the node.
- **`labelString: "master"`**: Labels that can be used to target this node in pipelines.
- **`launcher.jnlp`**: JNLP (Java Network Launch Protocol) launcher configuration.
  - **`workDirSettings`**: Working directory settings.
    - **`disabled: false`**: Work directory is enabled.
    - **`failIfWorkDirIsMissing: false`**: Don't fail if work directory doesn't exist.
    - **`internalDir: "remoting"`**: Internal directory name.
    - **`workDirPath: "/var/jenkins_home"`**: Path to the working directory.

**Purpose**: This configuration ensures the master node is properly set up and
can execute builds.

## Docker Cloud Configuration

### `jenkins.clouds.docker`

```yaml
clouds:
  - docker:
      name: "docker"
      dockerApi:
        dockerHost:
          uri: "unix:///var/run/docker.sock"
        connectTimeout: 60
        readTimeout: 60

      templates:
        - labelString: "docker"
          instanceCapStr: "10"
          mode: NORMAL
          remoteFs: "/home/jenkins/agent"
          pullStrategy: PULL_LATEST
          pullTimeout: 300
          dockerTemplateBase:
            image: "jenkins/inbound-agent:lts-jdk21"
          connector:
            attach:
              user: "jenkins"
          retentionStrategy:
            idleMinutes: 5
```

**What it does**: Configures Docker Cloud, which allows Jenkins to dynamically
provision Docker containers as build agents.

**Components**:

- **`name: "docker"`**: Identifier for this cloud configuration.
- **`dockerApi.dockerHost.uri`**: Docker daemon connection URI.
  - **`unix:///var/run/docker.sock`**: Connects to Docker daemon via Unix socket
  (standard on Linux).
- **`connectTimeout: 60`**: Connection timeout in seconds when connecting to
Docker daemon.
- **`readTimeout: 60`**: Read timeout in seconds when reading from Docker daemon.
- **`templates`**: Defines agent container templates (list of template configurations).
  - **`labelString: "docker"`**: Label that pipelines can use to request this
  agent type.
  - **`instanceCapStr: "10"`**: Maximum number of containers of this template
  that can run simultaneously (as a string).
  - **`mode: NORMAL`**: Agent mode (NORMAL allows running builds).
  - **`remoteFs: "/home/jenkins/agent"`**: Root filesystem path inside the container.
  - **`pullStrategy: PULL_LATEST`**: Pull strategy for the image
  (options: `PULL_LATEST`, `PULL_NEVER`, `PULL_ALWAYS`).
  - **`pullTimeout: 300`**: Timeout in seconds for pulling the Docker image
  (default: 300 seconds).
  - **`dockerTemplateBase`**: Base configuration for Docker agent containers.
    - **`image: "jenkins/inbound-agent:lts-jdk21"`**: Docker image to use for
    agents (LTS JDK 21 version).
  - **`connector.attach.user: "jenkins"`**: User to run the agent process as
  inside the container.
  - **`retentionStrategy.idleMinutes: 5`**: Number of minutes an idle agent will
  be kept before being removed.

**How It Works**: When a pipeline requests an agent with `label 'docker'`,
Jenkins creates a container from the specified image, runs the build,
then removes the container after the specified idle time (5 minutes).

**Use Case**: Provides isolated, clean build environments for each job execution.
Agents are automatically cleaned up after being idle for 5 minutes.

**Example Pipeline Usage**:

```groovy
pipeline {
  agent { label 'docker' }
  stages {
    stage('Build') {
      steps {
        sh 'echo "Building in Docker agent"'
      }
    }
  }
}
```

## Unclassified Settings

### `unclassified.location`

```yaml
unclassified:
  location:
    url: "${JENKINS_URL}"
    adminAddress: "${JENKINS_ADMIN_EMAIL}"
```

**What it does**: Sets Jenkins system location settings.

**Components**:

- **`url`**: Public URL of the Jenkins instance (set via the `JENKINS_URL`
environment variable, required).
- **`adminAddress`**: Email address of the Jenkins administrator
(set via the `JENKINS_ADMIN_EMAIL` environment variable, required).

**Purpose**: These settings are used in email notifications, build links,
and other system-generated content.

**Environment Variables**: Both values are loaded from environment variables
that are set in the `.env` file or provided via Docker Compose.
The `setup-jenkins.sh` script prompts for these values and creates the `.env`
file automatically.

**Important**: Ensure `JENKINS_URL` matches your actual Jenkins URL
(e.g., `http://localhost:8080/` or `https://jenkins.example.com/`).

### `unclassified.globalLibraries`

```yaml
globalLibraries:
  libraries:
    - name: "shared-library"
      defaultVersion: "master"
      retriever:
        modernSCM:
          scm:
            git:
              id: "shared-library"
              remote: "https://github.com/jenkinsci/workflow-cps-global-lib-plugin.git"
```

**What it does**: Configures global shared libraries for Jenkins pipelines.

**Components**:

- **`name: "shared-library"`**: Library identifier.
- **`defaultVersion: "master"`**: Git branch/tag to use by default.
- **`retriever.modernSCM.scm.git`**: Git SCM configuration.
  - **`id`**: Unique identifier.
  - **`remote`**: Git repository URL.

**Purpose**: Shared libraries allow you to define reusable pipeline code that
can be imported into any Jenkinsfile.

**Usage in Pipeline**:

```groovy
@Library('shared-library') _
```

**Note**: The example uses a demo repository. Replace with your own shared
library repository.

## Tool Installations

### `tool.git`

```yaml
tool:
  git:
    installations:
      - name: "Default"
        home: "git"
```

**What it does**: Configures Git installation for Jenkins.

**Components**:

- **`name: "Default"`**: Installation name (used in pipelines).
- **`home: "git"`**: Path to Git executable or "git" to use system PATH.

**Purpose**: Allows Jenkins to use Git for source control operations.

**Usage**: Jenkins will automatically find Git using this configuration when
checking out repositories.

### `tool.docker`

```yaml
docker:
  installations:
    - name: "Docker"
      home: "/usr/bin/docker"
```

**What it does**: Configures Docker installation for Jenkins.

**Components**:

- **`name: "Docker"`**: Installation name (used in pipelines).
- **`home: "/usr/bin/docker"`**: Path to Docker executable.

**Purpose**: Allows Jenkins pipelines to use Docker commands (build images,
run containers, etc.).

**Note**: This path should match where Docker CLI is installed in your Jenkins
container (see Dockerfile).

## Environment Variables

The configuration uses environment variables for sensitive values and configuration:

### Password Variables (Loaded from Docker Compose Secrets)

- **`${JENKINS_ADMIN_PASSWORD}`**: Admin user password
(loaded from Docker Compose secret `jenkins_admin_password`).
- **`${JENKINS_DEVOPS_PASSWORD}`**: DevOps user password
(loaded from Docker Compose secret `jenkins_devops_password`).

**How It Works**: Passwords are stored in secret files
(`secrets/jenkins_admin_password` and `secrets/jenkins_devops_password`) and loaded
into environment variables at container startup via the `command` override
in `docker-compose.yaml`. The secrets are automatically generated by the
`setup-jenkins.sh` script using `openssl rand -base64 32`.

### Configuration Variables (Set in `.env` file)

- **`${JENKINS_URL}`**: Public URL of the Jenkins instance (required, e.g., `http://localhost:8080/`).
- **`${JENKINS_ADMIN_EMAIL}`**: Email address of the Jenkins administrator
(required, e.g., `admin@example.com`).

**Set in**: `.env` file (created automatically by `setup-jenkins.sh`) or shell
environment variables.

## Best Practices

1. **Never commit passwords**: Passwords are stored in `secrets/` directory
(git-ignored) and loaded via Docker Compose secrets.
2. **Use the setup script**: Use `setup-jenkins.sh` to automatically generate
secure passwords and create the `.env` file.
3. **Version control**: Keep `jenkins.yaml` in version control for reproducibility,
but never commit `.env` or `secrets/` directory.
4. **Test changes**: Test configuration changes in a development environment first.
5. **Document customizations**: Add comments for non-standard configurations.
6. **Regular updates**: Review and update configurations as Jenkins and plugins evolve.
7. **Rotate passwords**: To rotate passwords, regenerate secret files and
restart Jenkins.

## Additional Resources

- [Jenkins Configuration as Code Plugin Documentation](https://github.com/jenkinsci/configuration-as-code-plugin)
- [JCasC Schema Reference](https://github.com/jenkinsci/configuration-as-code-plugin/blob/master/docs/SCHEMAS.md)
- [Jenkins Pipeline Documentation](https://www.jenkins.io/doc/book/pipeline/)
